# Makefile for CLISP module set clx

srcdir = @srcdir@
CC = @CC@
CPPFLAGS = @CPPFLAGS@
CFLAGS = -O
CLISP = clisp -q -norc
INCLUDES = $$($(CLISP) -b)/linkkit
LN = ln
LN_S = ln -s
SHELL = /bin/sh

DISTRIBFILES = clx.o link.sh Makefile \
	$(srcdir)/clx-preload.lisp $(srcdir)/clx.lisp \
	$(srcdir)/image.lisp $(srcdir)/resource.lisp
distribdir =

### Custom defs.
CCMP2C = ../../ccmp2c
RM = rm -f
WANTS = @WANTS@
X_CFLAGS = @X_CFLAGS@

all : clx.fas image.fas resource.fas clx.o clx-preload.lisp

clx.fas clx.lib: $(srcdir)/clx.lisp $(srcdir)/clx-preload.lisp
	$(CLISP) -i $(srcdir)/clx-preload.lisp -c $< -o ./

%.fas: $(srcdir)/%.lisp clx.lib
	$(CLISP) -i $(srcdir)/clx-preload.lisp -c $< -o ./

clx.d: $(srcdir)/clx.f
	$(CCMP2C) $< > genclx.c
	$(CC) $(CPPFLAGS) $(CFLAGS) $(WANTS) genclx.c -o genclx
	./genclx -l -o clx.d > clx.d
	$(RM) genclx.c
	$(RM) genclx

clx.c: clx.d
	$(CLISP) -C $(INCLUDES)/modprep clx.d clx.c

clx.o: clx.c
	$(CC) $(CPPFLAGS) $(CFLAGS) $(X_CFLAGS) -I$(INCLUDES) -c clx.c

clx-preload.lisp : $(srcdir)/clx-preload.lisp
	$(LN_S) $< .

# Make a module
clisp-module : all

# Make a module distribution into $(distribdir)
clisp-module-distrib : clisp-module force
	$(LN) $(DISTRIBFILES) $(distribdir)


clean : force
	$(RM) genclx.c genclx *.lib *.fas clx.e clx.d clx.c clx.o

force:

